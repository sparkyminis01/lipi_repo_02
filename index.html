<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Effortlessly track trip expenses, manage currency conversions, and create summary reports, even offline. Your ultimate free PWA for travel budgeting.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸš€</text></svg>">
    <title>LipiKit Trip Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#9333ea">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f3e8ff 0%, #e5e7eb 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .hidden { display: none !important; }
        
        h1 { font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 1rem; }
        h2 { font-size: 1.25rem; font-weight: bold; color: #1f2937; margin-bottom: 0.75rem; }
        h3 { font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
        
        p { color: #6b7280; margin-bottom: 1rem; }
        
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: #9333ea;
            color: white;
        }
        .btn-primary:hover { background: #7c3aed; }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover { background: #4b5563; }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        .btn-success:hover { background: #047857; }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        .btn-danger:hover { background: #b91c1c; }
        
        .btn-full { width: 100%; }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #9333ea;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
        }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        
        .quick-select-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: none;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #4b5563;
        }
        
        .quick-select-btn.active {
            background: #9333ea;
            color: white;
        }
        
        .status-indicator {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-online { color: #065f46; }
        .status-online .status-dot { background: #059669; }
        .status-offline { color: #9d174d; }
        .status-offline .status-dot { background: #dc2626; }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .trip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .summary-table th,
        .summary-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .summary-table th {
            background: #f9fafb;
            font-weight: 600;
        }
        
        .tab-container {
            display: inline-flex;
            background: #f3f4f6;
            border-radius: 20px;
            padding: 0.25rem;
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            border-radius: 16px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
        }
        
        .tab.active {
            background: white;
            color: #9333ea;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .back-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .back-btn:hover { color: #374151; }
        
        .text-red { color: #dc2626; }
        .text-green { color: #059669; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        
        .bg-red { background: #fee2e2; color: #991b1b; padding: 0.5rem; border-radius: 6px; }
        .bg-green { background: #d1fae5; color: #065f46; padding: 0.5rem; border-radius: 6px; }
        
        details {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        summary {
            padding: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            background: #f9fafb;
        }
        
        details p {
            padding: 0.75rem;
            margin: 0;
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        footer {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        footer p {
            margin-bottom: 0.5rem;
        }
        
        footer a {
            color: #9333ea;
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .flex { flex-direction: column; }
            .card { padding: 1rem; }
        }

        .btn-install {
            display: block;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: #9333ea;
            color: white;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: background 0.2s;
        }
        
        .btn-install:hover {
            background: #7c3aed;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- PIN Modal -->
        <div id="pin-modal" class="modal hidden">
            <div class="modal-content">
                <h2>Enter PIN to Sync</h2>
                <p>Please enter the security PIN to sync your data.</p>
                <form id="pin-modal-form">
                    <div class="form-group">
                        <input type="password" id="pin-modal-input" placeholder="Enter PIN" maxlength="4" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Submit</button>
                    <div id="pin-modal-message" class="text-red text-sm mt-2"></div>
                </form>
            </div>
        </div>

        <!-- Reset Confirmation Modal -->
        <div id="reset-confirmation-modal" class="modal hidden">
            <div class="modal-content">
                <h2>Reset All Data</h2>
                <p>Are you sure you want to delete all data? This will remove all trips, expenses, and user data permanently. This action cannot be undone.</p>
                <div class="flex gap-2" style="margin-top: 1rem;">
                    <button id="confirm-reset-btn" class="btn btn-danger" style="flex: 1;">Delete All Data</button>
                    <button id="cancel-reset-btn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Message Modal -->
        <div id="message-modal" class="modal hidden">
            <div class="modal-content">
                <h2 id="message-modal-title"></h2>
                <p id="message-modal-body"></p>
                <button id="message-modal-close" class="btn btn-primary btn-full">OK</button>
            </div>
        </div>

        <!-- User Creation View -->
        <div id="user-creation-view" class="card hidden">
            <h1>Create Your Profile</h1>
            <p>Enter a local username (optionally mapped to synced data if you sync to our servers). This cannot be changed later.</p>
            <form id="user-creation-form">
                <div class="form-group">
                    <label for="user-display-name">Username</label>
                    <input type="text" id="user-display-name" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Create Profile</button>
            </form>
        </div>

        <!-- Trip List View -->
        <div id="trip-list-view" class="card hidden">
            <h1><span id="user-greeting"></span>Your Trips</h1>
            <button id="add-trip-btn" class="btn btn-primary btn-full mb-4">Add New Trip</button>
            
            <form id="add-trip-form" class="hidden">
                <div class="form-group">
                    <label for="new-trip-name">Trip Name</label>
                    <input type="text" id="new-trip-name" required>
                </div>
                <div class="form-group">
                    <label for="new-trip-currencies">Select Trip Currencies (Hold Ctrl/Cmd to select multiple)</label>
                    <select id="new-trip-currencies" multiple style="height: 120px;"></select>
                </div>
                <div class="form-group">
                    <label for="new-trip-base-currency">Base Currency (for exchange rates and reports)</label>
                    <select id="new-trip-base-currency" required>
                        <option value="" disabled selected>Select a base currency</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">This currency will be used for fetching exchange rates and generating the base currency expense report.</p>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="new-trip-start">Start Date</label>
                        <input type="date" id="new-trip-start" required>
                    </div>
                    <div class="form-group">
                        <label for="new-trip-end">End Date</label>
                        <input type="date" id="new-trip-end" required>
                    </div>
                </div>
                <div id="trip-date-message" class="text-red text-sm mb-2 hidden"></div>
                <button type="submit" class="btn btn-primary btn-full">Save Trip</button>
            </form>
            
            <div id="trip-list"></div>
        </div>

        <!-- Expense Form View -->
        <div id="expense-form-view" class="card hidden">
            <button type="button" id="back-to-trips-btn" class="back-btn">&larr; Back to Trips</button>
            
            <div id="status-indicator" class="status-indicator">
                <span id="status-dot" class="status-dot"></span>
                <span id="status-text">Offline</span>
            </div>
            
            <h1>Trip: <span id="active-trip-name" style="color: #9333ea;"></span> (<span id="active-trip-base-currency" style="color: #9333ea;"></span>)</h1>
            <p class="text-sm" style="color: #6b7280;">Add a new expense</p>
            
            <button id="manual-sync-btn" class="btn btn-success btn-full mb-4">Sync Now (PIN needed)</button>
            
            <form id="expense-form">
                <input type="hidden" id="selected-currency">
                <input type="hidden" id="selected-category">
                <input type="hidden" id="selected-mode">
                
                <div id="offline-message" class="hidden bg-red mb-4">
                    You are offline. Please connect to the internet to sync data.
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="expense-date">Date</label>
                        <input type="date" id="expense-date" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <div id="quick-category-buttons" class="flex flex-wrap gap-1 mt-1"></div>
                    </div>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="number" id="amount" required>
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <div id="quick-currency-buttons" class="flex flex-wrap gap-1 mt-1"></div>
                    </div>
                    <div class="form-group">
                        <label>Mode</label>
                        <div id="quick-mode-buttons" class="flex flex-wrap gap-1 mt-1"></div>
                    </div>
                </div>
                
                <div class="flex gap-2 items-end">
                    <div class="form-group" style="flex: 1;">
                        <label for="place">Place (e.g., Cafe, Store Name)</label>
                        <input type="text" id="place">
                    </div>
                    <button id="add-location-btn" type="button" class="btn btn-secondary">Add Location</button>
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" rows="2"></textarea>
                </div>
                
                <div id="location-display" class="text-sm text-gray-500 mt-2 hidden"></div>
                
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Expense</button>
                    <button type="button" id="reset-btn" class="btn btn-secondary">Reset</button>
                </div>
            </form>
        </div>

        <!-- Data Queue Section -->
        <div id="data-queue-section" class="card hidden">
            <h2>Data Queue</h2>
            <div class="mb-4">
                <h3 class="text-green">Synced Data</h3>
                <ul id="synced-list" style="list-style: disc; padding-left: 1.5rem; color: #6b7280;"></ul>
            </div>
            <div class="mb-4">
                <h3 class="text-red">Unsynced Data</h3>
                <ul id="unsynced-list" style="list-style: disc; padding-left: 1.5rem; color: #6b7280;"></ul>
            </div>
            <button id="export-data-btn" class="btn btn-secondary btn-full">Export Data as JSON</button>
        </div>

        <!-- Summary Section -->
        <div id="summary-section" class="card hidden">
            <h2>Trip Expenses Summary</h2>
            <div class="tab-container">
                <button id="summary-tab-local" class="tab active">Local currencies</button>
                <button id="summary-tab-base" class="tab">Base Currency</button>
            </div>
            
            <div id="base-conversion-panel" class="hidden mb-2">
                <div class="flex items-center justify-between gap-2 mb-2">
                    <p class="text-sm">Rates to <span id="base-currency-label"></span> (1 unit = ? <span id="base-currency-label-2"></span>)</p>
                    <button id="fetch-rates-btn" class="btn" style="background: #2563eb; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Fetch Rates</button>
                </div>
                <div id="base-inputs" class="grid-3"></div>
                <div id="base-missing-warning" class="hidden text-xs text-red mt-1"></div>
                <p id="rates-fetch-note" class="text-xs hidden mt-1" style="color: #6b7280;"></p>
            </div>
            
            <div id="total-expenses-summary"></div>
            <div id="category-expenses-summary"></div>
        </div>

        <!-- Info Cards -->
        <div class="grid-2">
            <div class="card text-center">
                <h1 style="font-size: 1.75rem;">LipiKit.com</h1>
                <p>Your gateway to powerful apps for business, personal, and travel productivity.</p>
                <p class="text-sm" style="color: #6b7280;">Powered by SparkyMinis Media-Tech LLP. For inquiries, contact <a href="mailto:connect@sparkyminis.com" style="color: #9333ea;">connect@sparkyminis.com</a>.</p>
            </div>
            <div class="card text-center">
                <h2>Trip Expense Tracker</h2>
                <p>Effortlessly track your trip expenses, even offline! Totally Free!! This app saves your expenses locally and syncs them to our secure servers when you choose. Currency conversion and summary reports built-in.</p>
                <button id="install-btn" class="btn-install" disabled>
                    Install App
                </button>
                <div id="fallback-install">
                    <span>
                        &nbsp;
                    </span>
                    
                    <p>If above Install button does not work then, tap the  <strong>three dots menu </strong> and select  <strong>"Add to Home Screen"</strong> and/or  <strong>"Install app"</strong>.</p>
                </div>
            </div>
        </div>

        <!-- FAQ Section -->
        <div id="faq-section" class="card">
            <h2>Frequently Asked Questions</h2>
            <div id="faq-list"></div>
        </div>

        <!-- Reset Data Section -->
        <div class="card text-center">
            <h2>Data Management</h2>
            <p>Need to start fresh? You can reset all your data including trips, expenses, and user profile.</p>
            <button id="reset-all-data-btn" class="btn btn-danger btn-full">Reset All Data</button>
        </div>
    </div>

    <footer>
        <p>Get in Touch<br>For inquiries, contact us at: <a href="mailto:connect@sparkyminis.com">connect@sparkyminis.com</a></p>
        <p><a href="https://PriyankaDatar.com">Founder's Desk</a> | <a href="https://lipikit.com">LipiKit Apps</a></p>
        <p>Â© 2025 SparkyMinis Media-Tech LLP. All Rights Reserved.</p>
    </footer>

    <script src="crypto-js.min.js"></script>
    <script>
        // Configuration
        const HASHED_PIN = "07625cda1ed6dad6aa4cf70c899207812c2b8bc99e2f0774bc321e9b6573113c";
        const APP_CONFIG = {
            googleFormActionUrl: 'https://docs.google.com/forms/d/e/1FAIpQLSdkfyEAqMf5h0rLPWuXw1PmywLct2-3VbIfSQu4iyEc2bLo9Q/formResponse',
            googleFormFields: {
                name: 'entry.1731583832',
                tripName: 'entry.1093227282',
                expenseDate: 'entry.505163115',
                amount: 'entry.1623455754',
                currency: 'entry.1004211902',
                category: 'entry.59253883',
                place: 'entry.283121596',
                notes: 'entry.261715790',
                location: 'entry.56139846',
                mode: 'entry.1829164279'
            },
            categories: ["Food", "Transport", "Accommodation", "Shopping", "Activities", "Groceries", "Other"],
            currencies: ["INR", "USD", "EUR", "SGD", "THB", "MYR", "VND", "GBP", "JPY", "CAD", "AUD"],
            currencyNames: {
                INR: "Indian Rupee", USD: "United States Dollar", EUR: "Euro", SGD: "Singapore Dollar",
                THB: "Thai Baht", MYR: "Malaysian Ringgit", VND: "Vietnamese Dong", GBP: "British Pound Sterling",
                JPY: "Japanese Yen", CAD: "Canadian Dollar", AUD: "Australian Dollar"
            },
            modes: ["Cash", "Credit Card", "Prepaid Card"],
            pin: HASHED_PIN,
            faqs:[
            { "question": "How do I reset my data?", "answer": "To reset all data, go to your browser's settings, find the site data for LipiKit.com (usually under Privacy or Site Settings), and delete it. This will clear all local data, including trips and expenses." },
            { "question": "How can I change my username?", "answer": "Usernames cannot be changed once set. To use a new username, delete the site data in your browser's settings and reload the app to create a new profile." },
            { "question": "How is my privacy protected?", "answer": "All data is stored locally in your browser and never leaves your device unless you choose to sync. Syncing requires a secure PIN and sends data only to our secure servers." },
            { "question": "How do I sync my data?", "answer": "Click 'Sync Now,' enter the secure PIN, and ensure you're online. Your expenses will be sent to our secure servers." },
            { "question": "How can I get an expense report across all trips?", "answer": "For a consolidated report across multiple trips, email connect@sparkyminis.com with your request, and we will assist with generating the report manually." },
            { "question": "Can I use this app offline?", "answer": "Yes! This app is a Progressive Web App (PWA) and is designed to work fully offline. You can add new expenses and view all your saved data without an internet connection. It will automatically sync your changes once you are back online." },
            { "question": "How does the currency conversion feature work?", "answer": "The app fetches the latest currency exchange rates from the internet when you are online. Once downloaded, it stores them locally, allowing you to convert expenses even while offline." },
            { "question": "What if the app doesn't show the 'Install' button?", "answer": "On most modern browsers, the 'Install' button appears automatically when the app is ready. If you don't see it, you can usually install the app from your browser's menu (e.g., the three-dot menu in Chrome) by selecting 'Install app'." },
            { "question": "How do I add a new expense?", "answer": "To add a new expense, simply tap the '+' button, fill in the details like the amount and category, and tap 'Save.' The new expense will be instantly added to your current trip." },
            { "question": "What will not work if I have no internet?", "answer": "Without an internet connection, data sync and fetching the latest currency exchange rates will not work. However, you can still enter exchange rates manually." },
            { "question": "How do I add a new trip?", "answer": "You can add a new trip by navigating to the trip selection screen and using the 'Add New Trip' button. This will create a fresh entry for your new travel expenses." },
            { "question": "How can I get my data sync PIN?", "answer": "Data sync PINs are provided on a restricted basis. For access, please contact connect@sparkyminis.com, providing your username and a brief description of your request." },
            { "question": "What new features are planned for the future?", "answer": "We are continuously working on new features. Upcoming plans include the ability to share trips, set budgets, and generate detailed reports in PDF/CSV format. We welcome your feedback and suggestions via email at connect@sparkyminis.com." }
]
        };

        // Storage Keys
        const UNSYNCED_EXPENSES_KEY = 'unsyncedExpenses';
        const SYNCED_EXPENSES_KEY = 'syncedExpenses';
        const TRIPS_KEY = 'tripList';
        const ACTIVE_TRIP_KEY = 'activeTrip';
        const CONVERSION_RATES_KEY = 'tripConversionRatesBase';
        const APP_USER_KEY = 'appUser';

        // DOM Elements
        const elements = {
            userCreationView: document.getElementById('user-creation-view'),
            userCreationForm: document.getElementById('user-creation-form'),
            userDisplayNameInput: document.getElementById('user-display-name'),
            userGreeting: document.getElementById('user-greeting'),
            tripListView: document.getElementById('trip-list-view'),
            expenseFormView: document.getElementById('expense-form-view'),
            dataQueueSection: document.getElementById('data-queue-section'),
            summarySection: document.getElementById('summary-section'),
            totalExpensesSummaryDiv: document.getElementById('total-expenses-summary'),
            categoryExpensesSummaryDiv: document.getElementById('category-expenses-summary'),
            summaryTabLocal: document.getElementById('summary-tab-local'),
            summaryTabBase: document.getElementById('summary-tab-base'),
            basePanel: document.getElementById('base-conversion-panel'),
            baseInputsDiv: document.getElementById('base-inputs'),
            baseMissingWarning: document.getElementById('base-missing-warning'),
            baseCurrencyLabel: document.getElementById('base-currency-label'),
            baseCurrencyLabel2: document.getElementById('base-currency-label-2'),
            fetchRatesBtn: document.getElementById('fetch-rates-btn'),
            ratesFetchNote: document.getElementById('rates-fetch-note'),
            addTripBtn: document.getElementById('add-trip-btn'),
            addTripForm: document.getElementById('add-trip-form'),
            newTripNameInput: document.getElementById('new-trip-name'),
            newTripCurrenciesSelect: document.getElementById('new-trip-currencies'),
            newTripBaseCurrencySelect: document.getElementById('new-trip-base-currency'),
            newTripStartInput: document.getElementById('new-trip-start'),
            newTripEndInput: document.getElementById('new-trip-end'),
            tripList: document.getElementById('trip-list'),
            activeTripNameSpan: document.getElementById('active-trip-name'),
            activeTripBaseCurrencySpan: document.getElementById('active-trip-base-currency'),
            backToTripsBtn: document.getElementById('back-to-trips-btn'),
            expenseForm: document.getElementById('expense-form'),
            expenseDateInput: document.getElementById('expense-date'),
            amountInput: document.getElementById('amount'),
            placeInput: document.getElementById('place'),
            notesTextarea: document.getElementById('notes'),
            addLocationBtn: document.getElementById('add-location-btn'),
            locationDisplay: document.getElementById('location-display'),
            quickCategoryButtonsContainer: document.getElementById('quick-category-buttons'),
            quickCurrencyButtonsContainer: document.getElementById('quick-currency-buttons'),
            quickModeButtonsContainer: document.getElementById('quick-mode-buttons'),
            syncedList: document.getElementById('synced-list'),
            unsyncedList: document.getElementById('unsynced-list'),
            manualSyncBtn: document.getElementById('manual-sync-btn'),
            exportDataBtn: document.getElementById('export-data-btn'),
            selectedCurrencyInput: document.getElementById('selected-currency'),
            selectedCategoryInput: document.getElementById('selected-category'),
            selectedModeInput: document.getElementById('selected-mode'),
            offlineMessageDiv: document.getElementById('offline-message'),
            tripDateMessageDiv: document.getElementById('trip-date-message'),
            resetBtn: document.getElementById('reset-btn'),
            faqList: document.getElementById('faq-list'),
            pinModal: document.getElementById('pin-modal'),
            pinModalForm: document.getElementById('pin-modal-form'),
            pinModalInput: document.getElementById('pin-modal-input'),
            pinModalMessage: document.getElementById('pin-modal-message'),
            messageModal: document.getElementById('message-modal'),
            messageModalTitle: document.getElementById('message-modal-title'),
            messageModalBody: document.getElementById('message-modal-body'),
            messageModalClose: document.getElementById('message-modal-close'),
            resetConfirmationModal: document.getElementById('reset-confirmation-modal'),
            confirmResetBtn: document.getElementById('confirm-reset-btn'),
            cancelResetBtn: document.getElementById('cancel-reset-btn'),
            resetAllDataBtn: document.getElementById('reset-all-data-btn')
        };

        // State Variables
        let appUser = null;
        let activeTrip = null;
        let currentLocation = null;
        let syncAttemptOrigin = null;
        let summaryMode = 'local';
        let conversionRates = {};
        let lastRatesFetchDate = null;

        // Utility Functions
        function showMessage(title, message) {
            elements.messageModalTitle.textContent = title;
            elements.messageModalBody.textContent = message;
            elements.messageModal.classList.remove('hidden');
        }

        function closeMessageModal() {
            elements.messageModal.classList.add('hidden');
        }

        function resetAllData() {
            // Clear all localStorage data
            localStorage.removeItem(UNSYNCED_EXPENSES_KEY);
            localStorage.removeItem(SYNCED_EXPENSES_KEY);
            localStorage.removeItem(TRIPS_KEY);
            localStorage.removeItem(ACTIVE_TRIP_KEY);
            localStorage.removeItem(CONVERSION_RATES_KEY);
            localStorage.removeItem(APP_USER_KEY);
            
            // Reset app state
            appUser = null;
            activeTrip = null;
            currentLocation = null;
            conversionRates = {};
            lastRatesFetchDate = null;
            
            // Close modal and show user creation view
            elements.resetConfirmationModal.classList.add('hidden');
            showView('user-creation');
            
            // Show confirmation message
            showMessage("Data Reset Complete", "All data has been deleted successfully. You can now create a new profile.");
        }

        function getLocalData(key) {
            try {
                return JSON.parse(localStorage.getItem(key)) || [];
            } catch (e) {
                console.error('Failed to parse data from localStorage:', e);
                return [];
            }
        }

        function saveDataLocally(data, key) {
            let currentData = getLocalData(key);
            currentData.push(data);
            localStorage.setItem(key, JSON.stringify(currentData));
        }

        function showView(viewId) {
            elements.userCreationView.classList.add('hidden');
            elements.tripListView.classList.add('hidden');
            elements.expenseFormView.classList.add('hidden');
            elements.dataQueueSection.classList.add('hidden');
            elements.summarySection.classList.add('hidden');

            if (viewId === 'user-creation') {
                elements.userCreationView.classList.remove('hidden');
            } else if (viewId === 'trip-list') {
                elements.tripListView.classList.remove('hidden');
            } else if (viewId === 'expense-form') {
                elements.expenseFormView.classList.remove('hidden');
                elements.dataQueueSection.classList.remove('hidden');
                elements.summarySection.classList.remove('hidden');
            }
        }

        function updateActiveTrip(trip) {
            activeTrip = trip;
            if (trip) {
                localStorage.setItem(ACTIVE_TRIP_KEY, JSON.stringify(trip));
                elements.activeTripNameSpan.textContent = trip.name;
                elements.activeTripBaseCurrencySpan.textContent = trip.baseCurrency;
                elements.baseCurrencyLabel.textContent = trip.baseCurrency;
                elements.baseCurrencyLabel2.textContent = trip.baseCurrency;
                
                renderQuickCategories();
                renderQuickCurrencies();
                renderQuickModes();
                
                try {
                    const allRates = JSON.parse(localStorage.getItem(CONVERSION_RATES_KEY)) || {};
                    conversionRates = allRates[trip.name] || {};
                    lastRatesFetchDate = allRates[trip.name]?.lastFetchDate || null;
                } catch (e) {
                    conversionRates = {};
                    lastRatesFetchDate = null;
                }
                
                renderConversionInputs();
                
                const startDate = new Date(trip.start);
                const endDate = new Date(trip.end);
                const minDate = new Date(startDate);
                minDate.setDate(minDate.getDate() - 7);
                const maxDate = new Date(endDate);
                maxDate.setDate(maxDate.getDate() + 7);
                
                elements.expenseDateInput.min = minDate.toISOString().split('T')[0];
                elements.expenseDateInput.max = maxDate.toISOString().split('T')[0];
                
                showView('expense-form');
                renderExpenses();
            } else {
                localStorage.removeItem(ACTIVE_TRIP_KEY);
                showView('trip-list');
                renderTripList();
            }
        }

        function resetExpenseForm() {
            elements.expenseForm.reset();
            document.querySelectorAll('.quick-select-btn.active').forEach(btn => btn.classList.remove('active'));
            elements.locationDisplay.classList.add('hidden');
            currentLocation = null;
            elements.expenseDateInput.valueAsDate = new Date();
        }

        function renderTripList() {
            const trips = getLocalData(TRIPS_KEY);
            elements.tripList.innerHTML = '';
            
            if (trips.length === 0) {
                elements.tripList.innerHTML = '<div style="text-align: center; color: #6b7280; font-style: italic; padding: 2rem;">No trips found. Add one above!</div>';
            } else {
                trips.forEach(trip => {
                    const div = document.createElement('div');
                    div.className = 'trip-item';
                    div.innerHTML = `
                        <div>
                            <h3 style="font-weight: 600; color: #1f2937;">${trip.name} (${trip.baseCurrency})</h3>
                            <p style="font-size: 0.875rem; color: #6b7280;">${trip.start} to ${trip.end}</p>
                        </div>
                        <button class="btn btn-primary start-trip-btn" data-trip-id="${trip.id}">Select</button>
                    `;
                    elements.tripList.appendChild(div);
                });
            }
        }

        function renderExpenses() {
            const unsyncedData = getLocalData(UNSYNCED_EXPENSES_KEY);
            const syncedData = getLocalData(SYNCED_EXPENSES_KEY);
            
            elements.syncedList.innerHTML = '';
            syncedData.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.tripName}: ${item.amount} ${item.currency} for ${item.category} on ${item.expenseDate} (Synced)`;
                elements.syncedList.appendChild(li);
            });
            
            elements.unsyncedList.innerHTML = '';
            unsyncedData.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.tripName}: ${item.amount} ${item.currency} for ${item.category} on ${item.expenseDate} (Unsynced)`;
                elements.unsyncedList.appendChild(li);
            });
            
            renderSummary();
        }

        function renderSummary() {
            if (!activeTrip) {
                elements.summarySection.classList.add('hidden');
                return;
            }
            
            elements.summarySection.classList.remove('hidden');
            const allExpenses = [
                ...getLocalData(SYNCED_EXPENSES_KEY).filter(e => e.tripName === activeTrip.name),
                ...getLocalData(UNSYNCED_EXPENSES_KEY).filter(e => e.tripName === activeTrip.name)
            ];
            
            if (allExpenses.length === 0) {
                elements.totalExpensesSummaryDiv.innerHTML = `<h3>Overall Trip Total (${summaryMode === 'base' ? activeTrip.baseCurrency : 'Local'})</h3><p style="color: #6b7280; font-style: italic;">No expenses recorded for this trip yet.</p>`;
                elements.categoryExpensesSummaryDiv.innerHTML = '';
                return;
            }
            
            if (summaryMode === 'local') {
                elements.basePanel.classList.add('hidden');
                const totalsByCurrency = {};
                const totalsByCategory = {};
                
                allExpenses.forEach(expense => {
                    const amount = parseFloat(expense.amount) || 0;
                    const currency = expense.currency;
                    const category = expense.category;
                    
                    if (amount > 0 && currency && category) {
                        totalsByCurrency[currency] = (totalsByCurrency[currency] || 0) + amount;
                        if (!totalsByCategory[category]) totalsByCategory[category] = {};
                        totalsByCategory[category][currency] = (totalsByCategory[category][currency] || 0) + amount;
                    }
                });
                
                let totalHtml = '<h3>Overall Trip Total</h3>';
                if (Object.keys(totalsByCurrency).length > 0) {
                    totalHtml += '<ul style="list-style: disc; padding-left: 1.5rem; color: #6b7280;">';
                    for (const currency in totalsByCurrency) {
                        const name = APP_CONFIG.currencyNames[currency] || currency;
                        totalHtml += `<li><span style="font-weight: 600; color: #1f2937;">${totalsByCurrency[currency].toLocaleString()}</span> ${currency} (${name})</li>`;
                    }
                    totalHtml += '</ul>';
                } else {
                    totalHtml += '<p style="color: #6b7280; font-style: italic;">No valid expenses recorded for this trip yet.</p>';
                }
                elements.totalExpensesSummaryDiv.innerHTML = totalHtml;
                
                let categoryHtml = '<h3 style="margin-top: 2rem;">Expenses by Category</h3>';
                if (Object.keys(totalsByCategory).length > 0) {
                    categoryHtml += '<table class="summary-table"><thead><tr><th>Category</th><th>Total Spent</th></tr></thead><tbody>';
                    for (const category in totalsByCategory) {
                        const currencyStrings = Object.entries(totalsByCategory[category]).map(([currency, total]) => {
                            const name = APP_CONFIG.currencyNames[currency] || currency;
                            return `<span style="font-weight: 600;">${total.toLocaleString()}</span> ${currency} (${name})`;
                        });
                        categoryHtml += `<tr><td>${category}</td><td>${currencyStrings.join('<br>')}</td></tr>`;
                    }
                    categoryHtml += '</tbody></table>';
                } else {
                    categoryHtml = '';
                }
                elements.categoryExpensesSummaryDiv.innerHTML = categoryHtml;
            } else {
                elements.basePanel.classList.remove('hidden');
                const missing = new Set();
                let totalBase = 0;
                const totalsByCategoryBase = {};
                
                allExpenses.forEach(expense => {
                    const amount = parseFloat(expense.amount) || 0;
                    const currency = expense.currency;
                    const category = expense.category;
                    
                    if (currency !== activeTrip.baseCurrency && !(currency in conversionRates)) {
                        missing.add(currency);
                    }
                    
                    const rate = currency === activeTrip.baseCurrency ? 1 : parseFloat(conversionRates[currency]);
                    
                    if (amount > 0 && category && !isNaN(rate) && rate > 0) {
                        const val = amount * rate;
                        totalBase += val;
                        totalsByCategoryBase[category] = (totalsByCategoryBase[category] || 0) + val;
                    }
                });
                
                const missingCurrencies = Array.from(missing).filter(c => c !== activeTrip.baseCurrency);
                if (missingCurrencies.length > 0) {
                    elements.baseMissingWarning.textContent = `Add rates for: ${missingCurrencies.map(c => `${c} (${APP_CONFIG.currencyNames[c] || c})`).join(', ')}`;
                    elements.baseMissingWarning.classList.remove('hidden');
                } else {
                    elements.baseMissingWarning.classList.add('hidden');
                }
                
                const totalHtml = `<h3>Overall Trip Total (${activeTrip.baseCurrency})</h3><div style="font-size: 1.5rem; font-weight: bold; color: #9333ea;">${totalBase.toLocaleString(undefined, { maximumFractionDigits: 0 })} ${activeTrip.baseCurrency}</div>`;
                elements.totalExpensesSummaryDiv.innerHTML = totalHtml;
                
                let categoryHtml = `<h3 style="margin-top: 2rem;">Expenses by Category (${activeTrip.baseCurrency})</h3>`;
                if (Object.keys(totalsByCategoryBase).length > 0) {
                    categoryHtml += '<table class="summary-table"><thead><tr><th>Category</th><th>Total Spent</th></tr></thead><tbody>';
                    for (const category in totalsByCategoryBase) {
                        categoryHtml += `<tr><td>${category}</td><td><span style="font-weight: 600;">${totalsByCategoryBase[category].toLocaleString(undefined, { maximumFractionDigits: 0 })} ${activeTrip.baseCurrency}</span></td></tr>`;
                    }
                    categoryHtml += '</tbody></table>';
                } else {
                    categoryHtml += '<p style="color: #6b7280; font-style: italic;">No valid expenses with conversion rates yet.</p>';
                }
                elements.categoryExpensesSummaryDiv.innerHTML = categoryHtml;
            }
        }

function renderConversionInputs() {
    if (!activeTrip) return;

    elements.baseInputsDiv.innerHTML = '';
    elements.ratesFetchNote.classList.add('hidden');

    if (lastRatesFetchDate) {
        elements.ratesFetchNote.textContent = `Rates fetched from internet sources as of ${lastRatesFetchDate}`;
        elements.ratesFetchNote.classList.remove('hidden');
    }

    const currencies = (activeTrip.currencies || []).slice();
    const includeBase = currencies.includes(activeTrip.baseCurrency);

    currencies.forEach(curr => {
        if (curr === activeTrip.baseCurrency) {
            const wrap = document.createElement('div');
            // Modified styles for vertical stacking on mobile
            wrap.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; background: #f9fafb; border-radius: 6px; padding: 0.5rem;';
            wrap.innerHTML = `<span style="font-size: 0.75rem; color: #6b7280;">${curr} (${APP_CONFIG.currencyNames[curr] || curr})</span><div style="flex: 1; text-align: right; font-weight: 500; width: 100%;">1</div>`;
            elements.baseInputsDiv.appendChild(wrap);
        } else {
            const rateVal = conversionRates[curr] ?? '';
            const wrap = document.createElement('div');
            // Modified styles for vertical stacking on mobile
            wrap.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; background: #f9fafb; border-radius: 6px; padding: 0.5rem;';
            wrap.innerHTML = `
                <label style="font-size: 0.75rem; color: #6b7280;" for="base-rate-${curr}">${curr} (${APP_CONFIG.currencyNames[curr] || curr})</label>
                <input id="base-rate-${curr}" data-currency="${curr}" type="number" step="any" min="0" placeholder="e.g., 80" value="${rateVal}"
                    style="flex: 1; width: 100%; text-align: right; border-radius: 4px; border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem;" />
            `;
            elements.baseInputsDiv.appendChild(wrap);
        }
    });
}

        function persistConversionRates() {
            try {
                const allRates = JSON.parse(localStorage.getItem(CONVERSION_RATES_KEY)) || {};
                allRates[activeTrip.name] = { ...conversionRates, lastFetchDate: lastRatesFetchDate };
                localStorage.setItem(CONVERSION_RATES_KEY, JSON.stringify(allRates));
            } catch (e) { /* ignore */ }
        }

        function updateSummaryTabs() {
            if (summaryMode === 'local') {
                elements.summaryTabLocal.classList.add('active');
                elements.summaryTabBase.classList.remove('active');
            } else {
                elements.summaryTabBase.classList.add('active');
                elements.summaryTabLocal.classList.remove('active');
            }
        }

        function renderQuickCategories() {
            elements.quickCategoryButtonsContainer.innerHTML = '';
            APP_CONFIG.categories.forEach(category => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'quick-select-btn';
                button.textContent = category;
                button.dataset.value = category;
                elements.quickCategoryButtonsContainer.appendChild(button);
            });
        }

        function renderQuickCurrencies() {
            elements.quickCurrencyButtonsContainer.innerHTML = '';
            if (activeTrip && activeTrip.currencies) {
                activeTrip.currencies.forEach(currency => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'quick-select-btn';
                    button.textContent = currency;
                    button.dataset.value = currency;
                    elements.quickCurrencyButtonsContainer.appendChild(button);
                });
            }
        }

        function renderQuickModes() {
            elements.quickModeButtonsContainer.innerHTML = '';
            APP_CONFIG.modes.forEach(mode => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'quick-select-btn';
                button.textContent = mode;
                button.dataset.value = mode;
                elements.quickModeButtonsContainer.appendChild(button);
            });
        }

        function populateTripCurrenciesSelect() {
            elements.newTripCurrenciesSelect.innerHTML = '';
            APP_CONFIG.currencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = `${currency} - ${APP_CONFIG.currencyNames[currency] || currency}`;
                elements.newTripCurrenciesSelect.appendChild(option);
            });
        }

        function populateTripBaseCurrencySelect(currencies) {
            elements.newTripBaseCurrencySelect.innerHTML = '<option value="" disabled selected>Select a base currency</option>';
            currencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = `${currency} - ${APP_CONFIG.currencyNames[currency] || currency}`;
                elements.newTripBaseCurrencySelect.appendChild(option);
            });
        }

        function renderFaqs() {
            elements.faqList.innerHTML = '';
            APP_CONFIG.faqs.forEach(faq => {
                const details = document.createElement('details');
                const summary = document.createElement('summary');
                summary.textContent = faq.question;
                const p = document.createElement('p');
                p.textContent = faq.answer;
                details.appendChild(summary);
                details.appendChild(p);
                elements.faqList.appendChild(details);
            });
        }

        function handleQuickSelectClick(event, inputElement) {
            if (event.target.classList.contains('quick-select-btn')) {
                if (event.target.classList.contains('active')) return;
                const buttons = event.target.parentElement.querySelectorAll('.quick-select-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                inputElement.value = event.target.dataset.value;
            }
        }

        async function fetchExchangeRates(baseCurrency, targetCurrencies) {
            if (!navigator.onLine) {
                showMessage('Offline', 'Cannot fetch rates offline. Please enter manually.');
                return false;
            }
            
            const date = 'latest';
            const primaryUrl = `https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@${date}/v1/currencies/${baseCurrency.toLowerCase()}.min.json`;
            const fallbackUrl = `https://${date}.currency-api.pages.dev/v1/currencies/${baseCurrency.toLowerCase()}.min.json`;
            
            try {
                const response = await fetch(primaryUrl);
                if (!response.ok) throw new Error('Primary fetch failed');
                const data = await response.json();
                const rates = data[baseCurrency.toLowerCase()];
                
                targetCurrencies.forEach(curr => {
                    if (curr !== baseCurrency && rates[curr.toLowerCase()]) {
                        conversionRates[curr] = parseFloat((1 / rates[curr.toLowerCase()]).toFixed(4));
                    }
                });
                
                lastRatesFetchDate = new Date().toISOString().split('T')[0];
                persistConversionRates();
                return true;
            } catch (error) {
                console.error('Primary fetch failed, trying fallback:', error);
                try {
                    const response = await fetch(fallbackUrl);
                    if (!response.ok) throw new Error('Fallback fetch failed');
                    const data = await response.json();
                    const rates = data[baseCurrency.toLowerCase()];
                    
                    targetCurrencies.forEach(curr => {
                        if (curr !== baseCurrency && rates[curr.toLowerCase()]) {
                            conversionRates[curr] = parseFloat((1 / rates[curr.toLowerCase()]).toFixed(4));
                        }
                    });
                    
                    lastRatesFetchDate = new Date().toISOString().split('T')[0];
                    persistConversionRates();
                    return true;
                } catch (fallbackError) {
                    console.error('Fallback fetch failed:', fallbackError);
                    showMessage('Error', 'Failed to fetch exchange rates. Please try again later.');
                    return false;
                }
            }
        }

        async function startSync() {
            const unsyncedData = getLocalData(UNSYNCED_EXPENSES_KEY);
            if (unsyncedData.length === 0) {
                showMessage("Sync Info", "There is no new data to sync.");
                return;
            }
            
            let newlySyncedItems = [];
            let failedToSyncItems = [];
            
            for (const item of unsyncedData) {
                const formData = new FormData();
                formData.append(APP_CONFIG.googleFormFields.name, `${appUser.userId}:${appUser.displayName}`);
                formData.append(APP_CONFIG.googleFormFields.tripName, `${item.tripName}:${activeTrip.baseCurrency}`);
                
                Object.keys(APP_CONFIG.googleFormFields).forEach(key => {
                    if (key !== 'name' && key !== 'tripName' && item[key]) {
                        formData.append(APP_CONFIG.googleFormFields[key], item[key]);
                    }
                });
                
                try {
                    await fetch(APP_CONFIG.googleFormActionUrl, { method: 'POST', mode: 'no-cors', body: formData });
                    newlySyncedItems.push({ ...item, syncDate: new Date().toISOString() });
                } catch (error) {
                    console.error(`Failed to sync item with ID ${item.id}:`, error);
                    failedToSyncItems.push(item);
                }
            }
            
            if (newlySyncedItems.length > 0) {
                const currentSynced = getLocalData(SYNCED_EXPENSES_KEY);
                localStorage.setItem(SYNCED_EXPENSES_KEY, JSON.stringify([...currentSynced, ...newlySyncedItems]));
            }
            
            localStorage.setItem(UNSYNCED_EXPENSES_KEY, JSON.stringify(failedToSyncItems));
            
            if (newlySyncedItems.length > 0) {
                showMessage("Sync Complete", `${newlySyncedItems.length} expense(s) were successfully synced.`);
                renderExpenses();
            } else {
                showMessage("Sync Failed", "Could not sync data. Please check your internet connection and try again.");
            }
        }

        function exportDataAsJson() {
            const allData = {
                user: appUser,
                trips: getLocalData(TRIPS_KEY),
                syncedExpenses: getLocalData(SYNCED_EXPENSES_KEY),
                unsyncedExpenses: getLocalData(UNSYNCED_EXPENSES_KEY)
            };
            
            const jsonData = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trip_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function updateStatus() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const statusIndicator = document.getElementById('status-indicator');
            
            if (navigator.onLine) {
                statusText.textContent = 'Online';
                statusIndicator.className = 'status-indicator status-online';
            } else {
                statusText.textContent = 'Offline';
                statusIndicator.className = 'status-indicator status-offline';
            }
        }

        // Event Listeners
        elements.userCreationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const displayName = elements.userDisplayNameInput.value.trim();
            if (!displayName) {
                showMessage("Error", "Please enter a username.");
                return;
            }
            
            appUser = {
                userId: `user-${Date.now()}-${Math.random().toString(36).slice(2)}`,
                displayName
            };
            localStorage.setItem(APP_USER_KEY, JSON.stringify(appUser));
            elements.userGreeting.textContent = `Hi ${appUser.displayName}, `;
            showView('trip-list');
            renderTripList();
        });

        elements.addTripBtn.addEventListener('click', () => {
            elements.addTripForm.classList.toggle('hidden');
        });

        elements.addTripForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const startDate = new Date(elements.newTripStartInput.value);
            const endDate = new Date(elements.newTripEndInput.value);
            
            if (endDate < startDate) {
                elements.tripDateMessageDiv.textContent = 'Trip end date cannot be before the start date.';
                elements.tripDateMessageDiv.classList.remove('hidden');
                return;
            }
            
            const selectedCurrencies = Array.from(elements.newTripCurrenciesSelect.selectedOptions, option => option.value);
            const baseCurrency = elements.newTripBaseCurrencySelect.value;
            
            if (!selectedCurrencies.includes(baseCurrency)) {
                elements.tripDateMessageDiv.textContent = 'Base currency must be one of the selected trip currencies.';
                elements.tripDateMessageDiv.classList.remove('hidden');
                return;
            }
            
            elements.tripDateMessageDiv.classList.add('hidden');
            
            const newTrip = {
                id: Date.now(),
                name: elements.newTripNameInput.value,
                currencies: selectedCurrencies,
                baseCurrency: baseCurrency,
                start: elements.newTripStartInput.value,
                end: elements.newTripEndInput.value
            };
            
            const trips = getLocalData(TRIPS_KEY);
            trips.push(newTrip);
            localStorage.setItem(TRIPS_KEY, JSON.stringify(trips));
            
            elements.addTripForm.reset();
            elements.addTripForm.classList.add('hidden');
            renderTripList();
        });

        elements.newTripCurrenciesSelect.addEventListener('change', () => {
            const selectedCurrencies = Array.from(elements.newTripCurrenciesSelect.selectedOptions, option => option.value);
            populateTripBaseCurrencySelect(selectedCurrencies);
        });

        elements.pinModalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const enteredPinHash = CryptoJS.SHA256(elements.pinModalInput.value).toString();
            
            if (enteredPinHash === APP_CONFIG.pin) {
                elements.pinModal.classList.add('hidden');
                elements.pinModalMessage.textContent = '';
                elements.pinModalInput.value = '';
                if (syncAttemptOrigin === 'manual') startSync();
            } else {
                elements.pinModalMessage.textContent = 'Invalid PIN. Please try again.';
            }
        });

        elements.messageModalClose.addEventListener('click', closeMessageModal);

        // Reset data event listeners
        elements.resetAllDataBtn.addEventListener('click', () => {
            elements.resetConfirmationModal.classList.remove('hidden');
        });

        elements.confirmResetBtn.addEventListener('click', resetAllData);

        elements.cancelResetBtn.addEventListener('click', () => {
            elements.resetConfirmationModal.classList.add('hidden');
        });

        elements.tripList.addEventListener('click', (e) => {
            if (e.target.classList.contains('start-trip-btn')) {
                const tripId = parseInt(e.target.dataset.tripId, 10);
                const trips = getLocalData(TRIPS_KEY);
                const selectedTrip = trips.find(t => t.id === tripId);
                if (selectedTrip) updateActiveTrip(selectedTrip);
            }
        });

        elements.backToTripsBtn.addEventListener('click', () => updateActiveTrip(null));
        elements.resetBtn.addEventListener('click', resetExpenseForm);

        elements.expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const expenseData = {
                tripName: activeTrip.name,
                expenseDate: elements.expenseDateInput.value,
                amount: elements.amountInput.value,
                currency: elements.selectedCurrencyInput.value,
                category: elements.selectedCategoryInput.value,
                place: elements.placeInput.value,
                notes: elements.notesTextarea.value,
                location: currentLocation ? `Lat: ${currentLocation.latitude}, Lon: ${currentLocation.longitude}` : 'N/A',
                mode: elements.selectedModeInput.value,
                id: Date.now()
            };
            
            saveDataLocally(expenseData, UNSYNCED_EXPENSES_KEY);
            resetExpenseForm();
            renderExpenses();
        });

        elements.manualSyncBtn.addEventListener('click', () => {
            if (navigator.onLine) {
                syncAttemptOrigin = 'manual';
                elements.pinModal.classList.remove('hidden');
                elements.pinModalInput.focus();
                elements.offlineMessageDiv.classList.add('hidden');
            } else {
                elements.offlineMessageDiv.textContent = 'You are offline. Please connect to the internet to sync data.';
                elements.offlineMessageDiv.classList.remove('hidden');
            }
        });

        elements.exportDataBtn.addEventListener('click', exportDataAsJson);

        elements.summaryTabLocal.addEventListener('click', () => {
            if (summaryMode !== 'local') {
                summaryMode = 'local';
                updateSummaryTabs();
                renderSummary();
            }
        });

        elements.summaryTabBase.addEventListener('click', () => {
            if (summaryMode !== 'base') {
                summaryMode = 'base';
                updateSummaryTabs();
                renderSummary();
            }
        });

        elements.fetchRatesBtn.addEventListener('click', async () => {
            if (activeTrip && activeTrip.currencies && activeTrip.baseCurrency) {
                const success = await fetchExchangeRates(activeTrip.baseCurrency, activeTrip.currencies);
                if (success) {
                    renderConversionInputs();
                    renderSummary();
                }
            }
        });

        elements.baseInputsDiv.addEventListener('input', (e) => {
            const target = e.target;
            if (target && target.matches('input[data-currency]')) {
                const curr = target.getAttribute('data-currency');
                const val = target.value.trim();
                
                if (val === '') {
                    delete conversionRates[curr];
                } else {
                    const num = parseFloat(val);
                    if (!isNaN(num) && num >= 0) conversionRates[curr] = num;
                }
                
                persistConversionRates();
                if (summaryMode === 'base') renderSummary();
            }
        });

        elements.addLocationBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    currentLocation = { 
                        latitude: position.coords.latitude, 
                        longitude: position.coords.longitude 
                    };
                    elements.locationDisplay.textContent = `Location Captured: ${currentLocation.latitude.toFixed(4)}, ${currentLocation.longitude.toFixed(4)}`;
                    elements.locationDisplay.classList.remove('hidden');
                }, error => {
                    console.error("Geolocation error:", error);
                    elements.locationDisplay.textContent = "Unable to get location.";
                    elements.locationDisplay.classList.remove('hidden');
                });
            } else {
                elements.locationDisplay.textContent = "Geolocation is not supported by your browser.";
                elements.locationDisplay.classList.remove('hidden');
            }
        });

        elements.quickCategoryButtonsContainer.addEventListener('click', (e) => 
            handleQuickSelectClick(e, elements.selectedCategoryInput));
        elements.quickCurrencyButtonsContainer.addEventListener('click', (e) => 
            handleQuickSelectClick(e, elements.selectedCurrencyInput));
        elements.quickModeButtonsContainer.addEventListener('click', (e) => 
            handleQuickSelectClick(e, elements.selectedModeInput));

        // Online/Offline Status
        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);

        // Initialize App
        populateTripCurrenciesSelect();
        renderFaqs();
        updateStatus();
        elements.expenseDateInput.valueAsDate = new Date();
        updateSummaryTabs();

        try {
            appUser = JSON.parse(localStorage.getItem(APP_USER_KEY));
            if (appUser && appUser.displayName) {
                elements.userGreeting.textContent = `Hi ${appUser.displayName}, `;
                const savedActiveTrip = JSON.parse(localStorage.getItem(ACTIVE_TRIP_KEY));
                if (savedActiveTrip && savedActiveTrip.name) {
                    updateActiveTrip(savedActiveTrip);
                } else {
                    showView('trip-list');
                    renderTripList();
                }
            } else {
                showView('user-creation');
            }
        } catch (e) {
            showView('user-creation');
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    <script>
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Enable the button when the prompt is available
            if (installBtn) {
                installBtn.disabled = false;
            }
        });
        
        if (installBtn) {
            installBtn.addEventListener('click', (e) => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        } else {
                            console.log('User dismissed the install prompt');
                        }
                        deferredPrompt = null;
                        
                        // Hide or disable the button after a choice is made
                        if (installBtn) {
                            installBtn.disabled = true;
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>
