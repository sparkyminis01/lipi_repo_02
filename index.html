<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="LipiKit Trips - Track expenses, manage checklists, and plan your perfect trip">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✈️</text></svg>">  
  <title id="page-title">LipiKit Trips</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#14B8A6">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="appstyle.css">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="font-awesome.min.css" />

  <style>
    /* Loading spinner styles are now in style.css */
  </style>
  
  <!-- CryptoJS for PIN validation -->
  <script src="crypto-js.min.js"></script>
  
  <!-- Firebase SDK (v9 compat mode) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Loading Spinner -->
  <div id="app-loading">
    <div class="loading-logo">
      <img src="logo-trip-expense-tracker.png" alt="LipiKit Trips" class="logo-image">
      <div class="spinner"></div>
    </div>
    <div class="loading-text">Loading your travel companion...</div>
  </div>

  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo" onclick="location.reload()" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 12px;">
        <div>
          <span class="company-name" id="company-name">LipiKit</span>
          <span class="app-name" id="app-name">Trips</span>
        </div>
      </div>
      <button id="pwa-install-btn" class="btn btn-secondary" title="Install app" aria-label="Install app"
        style="display:inline-flex; margin-left:auto; padding:6px 10px; border-radius:16px; font-size:.9rem; line-height:1; align-items:center; gap:6px;">
        <i class="fas fa-download"></i>
        <span>Install</span>
      </button>
      <!-- Profile dropdown will be injected by profile-auth.js -->
    </header>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
      <div class="modal-content">
        <h2>Settings</h2>
        <div id="common-settings"></div>
        <div id="app-settings"></div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden">
      <div class="modal-content">
        <h2 id="confirmation-title">Confirm Action</h2>
        <p id="confirmation-message">Are you sure you want to proceed?</p>
        <div class="flex gap-2 mt-4">
          <button id="confirm-yes" class="btn btn-danger" style="flex:1;">Yes</button>
          <button id="confirm-no" class="btn btn-secondary" style="flex:1;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Profile section (for sign-in UI) -->
    <div id="profile-section"></div>

    <!-- Main App -->
    <div id="app-area" class="hidden">
      <div class="card text-center">
        <h2>Welcome to Your App!</h2>
        <p>This area will be populated by app.js with your application logic.</p>
      </div>
    </div>

    <!-- Compact Info Blocks -->
    <div class="info-grid">
      <div class="info-block" id="app-info-block"></div>
      <div class="info-block">
  <h2><i class="fas fa-heart" style="color: var(--success-color); margin-right: 0.5rem;"></i> Support LipiKit | Unlimited Trips</h2>
  <h3>To Keep Enjoying Free Apps</h3>
  <p>LipiKit is built ad-free and accessible for everyone—personalized travel planners, content editing suites, fitness trackers, and design prototypes, all in active development to spark joy in daily routines.</p>
  <p>Your support fuels AI-driven updates like smarter itineraries and seamless integrations, ensuring these tools stay free and evolving for travelers, creators, and dreamers alike.</p>
  <div style="display: flex; gap: 0.5rem; flex-direction: column; margin-top: 1rem;">
  <a href="https://razorpay.me/@dhanesh123" class="btn btn-primary" target="_blank" style="padding: 0.75rem 2rem; font-size: 1.1em; border-radius: 30px; font-weight: 600; text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
      <i class="fab fa-patreon"></i> Support LipiKit
  </a>
  <form><script src="https://checkout.razorpay.com/v1/payment-button.js" data-payment_button_id="pl_RZFSPdB6dMFgbp" async> </script> </form>
  <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-medium); text-align: center; font-style: italic;">
    Quick: Just enter your name, email & phone on the secure Razorpay page—we'll send a thank-you receipt!
  </p>
  <a href="https://rzp.io/rzp/NiFP60q" class="btn btn-primary" target="_blank" style="padding: 0.75rem 2rem; font-size: 1.1em; border-radius: 30px; font-weight: 600; text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
    <i class="fab fa-patreon"></i> Buy Pro Plan (Unlimited Trips)
  </a>
    <p style="margin-top: 1rem; font-size: 1rem; color: var(--text-medium); text-align: center; font-style: italic;"> Other ways to Get Pro Plan: <br>
Reach out to <a href="mailto:connect@sparkyminis.com" style="text-decoration: none; color: var(--primary-color);">connect@SparkyMinis.com</a>.  </p>
  </div>

</div>
      
      <div class="info-block">
        <div style="text-align: center; margin-bottom: 1rem;">
          <a href="https://sparkyminis.com" target="_blank" style="text-decoration: none;">
            <img src="logo.png" alt="SparkyMinis" style="height: 120px; width: auto; margin: 0 auto 0.5rem; display: block;">
            <h2 style="margin: 0; color: var(--primary-color); font-size: 1.1rem;">LipiKit by SparkyMinis</h2>
          </a>
        </div>
        <h3>Catalog of Productivity Apps for Everyone. Powered by <a href="https://sparkyminis.com" target="_blank" style="text-decoration: none;">SparkyMinis Media-Tech</a>. </h3>
        <p>SparkyMinis crafts AI-powered tools and vibrant content to empower intentional living.</p>
        <p>Personalized travel planners, content editing suites, fitness trackers, and design prototypes—all in active development to spark joy in daily routines.</p>
        <p>AI-driven business tools for HR teams and startups: Automated recruitment platforms, workflow optimizers, and analytics dashboards, primarily subscription-based for seamless scaling.</p>
        <a href="https://lipikit.com" class="btn btn-primary" target="_blank"
        style="padding: 0.75rem 2rem; font-size: 1.1em; border-radius: 30px; font-weight: 600;">Explore All Apps</a>
        <a href="mailto:connect@sparkyminis.com" class="btn btn-success"
        style="padding: 0.75rem 2rem; font-size: 1.1em; border-radius: 30px; font-weight: 600;">Contact Support</a>
      </div>
    </div>

    <!-- FAQ - Collapsible by default -->
    <div class="faq-section collapsed">
      <h2>Frequently Asked Questions</h2>
      <div id="faq-container"></div>
    </div>
  </div>

  <!-- Compact Footer -->
  <footer class="footer">
    <p>&copy; 2025 SparkyMinis Media-Tech LLP. All Rights Reserved.</p>
    <div class="footer-links">
      <a href="https://lipikit.com" target="_blank">LipiKit</a> |
      <a href="https://lipikit.com/privacy" target="_blank">Privacy</a> |
      <a href="https://lipikit.com/terms" target="_blank">Terms</a>
    </div>
    <p id="app-version" style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.8;"></p>
  </footer>

  <!-- Load app scripts -->
  <script>
    // Global function to show loading spinner
    function showAppLoading() {
      const loadingElement = document.getElementById('app-loading');
      if (loadingElement) {
        // Force reflow to ensure the element is rendered before adding the class
        void loadingElement.offsetHeight;
        loadingElement.classList.add('visible');
      }
    }

    // Global function to hide loading spinner
    function hideAppLoading() {
      const loadingElement = document.getElementById('app-loading');
      if (loadingElement) {
        loadingElement.classList.remove('visible');
        loadingElement.classList.add('hidden');
        // Remove from DOM after animation completes
        setTimeout(() => {
          loadingElement.style.display = 'none';
        }, 500);
      }
    }

    // Safety timeout to ensure spinner hides even if app fails to load
    let appLoaded = false;
    const LOADING_TIMEOUT = 10000; // 10 seconds

    // Wait a small amount of time before showing the spinner to prevent flash on fast loads
    let showSpinnerTimeout = setTimeout(() => {
      showAppLoading();
    }, 100);

    // Set a timeout to hide the spinner after max duration
    const loadingTimeout = setTimeout(() => {
      if (!appLoaded) {
        console.warn('App initialization taking too long, forcing spinner to hide');
        hideAppLoading();
      }
    }, LOADING_TIMEOUT);

    // Expose function to window for app.js to call
    window.appReady = function() {
      if (!appLoaded) {
        appLoaded = true;
        clearTimeout(loadingTimeout);
        clearTimeout(showSpinnerTimeout);
        hideAppLoading();
      }
    };

    // Handle DOM ready state
    document.addEventListener('DOMContentLoaded', function() {
      // If the spinner hasn't been shown yet, show it now
      clearTimeout(showSpinnerTimeout);
      showAppLoading();
      
      // If app.js hasn't called appReady within 1 second of DOMContentLoaded,
      // we'll show a warning but keep the spinner going until appReady is called
      setTimeout(() => {
        if (!appLoaded) {
          console.log('DOM loaded, waiting for app to initialize...');
          // Update loading text to indicate we're still working
          const loadingText = document.querySelector('#app-loading .loading-text');
          if (loadingText) {
            loadingText.textContent = 'Finalizing your experience...';
          }
        }
      }, 1000);
    });
  </script>
  <script src="min/config.js"></script>
  <script src="min/profile-auth.js"></script>
  <script src="min/settings.js"></script>
  <script src="min/appsettings.js"></script>
  <script src="min/dataset-manager.js"></script>
  <script src="min/faq.js"></script>
  <script src="min/app.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Initialize core services
      if(typeof AppConfig!=='undefined') AppConfig.init();
      if(typeof ProfileManager!=='undefined') ProfileManager.init();
      if(typeof SettingsManager!=='undefined') SettingsManager.init();
      if(typeof AppSettingsManager!=='undefined') AppSettingsManager.init();
      if(typeof FAQManager!=='undefined'){
        FAQManager.init();
        FAQManager.addSearchBox();
      }
      if(typeof AppManager!=='undefined') AppManager.init();
    });

    // KEEP ONLY THESE - HTML form modals only
    function showModal(id){
      document.getElementById(id).classList.remove('hidden');
    }
    
    function hideModal(id){
      document.getElementById(id).classList.add('hidden');
    }
    
    function showConfirmation(title, msg, onConfirm, onCancel=null){
      document.getElementById('confirmation-title').textContent = title;
      document.getElementById('confirmation-message').textContent = msg;
      const yesBtn = document.getElementById('confirm-yes');
      const noBtn = document.getElementById('confirm-no');
      yesBtn.replaceWith(yesBtn.cloneNode(true));
      noBtn.replaceWith(noBtn.cloneNode(true));
      document.getElementById('confirm-yes').addEventListener('click', () => {
        hideModal('confirmation-modal');
        if(onConfirm) onConfirm();
      });
      document.getElementById('confirm-no').addEventListener('click', () => {
        hideModal('confirmation-modal');
        if(onCancel) onCancel();
      });
      showModal('confirmation-modal');
    }
    

  </script>
  
  <script>
    (function(){
      let deferredPrompt = null;
      const btn = document.getElementById('pwa-install-btn');

      function isInstalled() {
        return window.matchMedia && window.matchMedia('(display-mode: standalone)').matches
          || window.navigator.standalone === true
          || document.referrer && document.referrer.startsWith('android-app://');
      }

      function showBtn() { if (btn) btn.style.display = 'inline-flex'; }
      function hideBtn() { if (btn) btn.style.display = 'none'; }

      // Initial state: show by default; hide only if already installed
      document.addEventListener('DOMContentLoaded', () => {
        if (isInstalled()) hideBtn(); else showBtn();
      });

      // Capture install prompt when available
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showBtn();
      });

      // Hide after successful install
      window.addEventListener('appinstalled', () => {
        deferredPrompt = null;
        hideBtn();
      });

      if (btn) {
        btn.addEventListener('click', async () => {
          // If we have the prompt, use it
          if (deferredPrompt) {
            btn.disabled = true;
            deferredPrompt.prompt();
            try {
              await deferredPrompt.userChoice;
            } finally {
              deferredPrompt = null;
              btn.disabled = false;
              // Keep visible unless appinstalled fires
            }
            return;
          }

          // Graceful fallback (iOS Safari / not eligible yet)
          alert('To install: Open your browser menu and choose "Add to Home screen".');
        });
      }
    })();
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('Service Worker registered with scope:', registration.scope);
        }).catch(error => {
          console.log('Service Worker registration failed:', error);
        });
      });
    }
  </script>

<!-- ============================================================================
     COMPLETE MODAL MANAGEMENT - Replace entire script section in (index).html
     
     This version:
     1. Separates HTML modals from app.js dynamic modals
     2. Fixes event propagation issues
     3. Allows proper button/close functionality
     4. Handles escape key correctly
     ============================================================================ -->

<script>
// ============================================================================
// MODAL MANAGEMENT SYSTEM v2 - Complete Rewrite
// ============================================================================

/**
 * Safe modal hiding function - respects app.js modals
 * @param {string} modalId - ID of modal to hide
 * @returns {boolean} - Success status
 */
function hideModal(modalId) {
    try {
        let modal = null;
        
        if (modalId) {
            modal = document.getElementById(modalId);
        } else {
            // Find ONLY HTML-based modals (not app-modal class)
            modal = document.querySelector('.modal:not(.app-modal):not(.hidden)');
        }
        
        if (!modal) {
            console.debug(`Modal not found: ${modalId}`);
            return false;
        }
        
        // Safety checks
        if (!modal.classList) {
            console.warn('Modal element does not have classList');
            return false;
        }
        
        if (modal.classList.contains('hidden')) {
            return true;
        }
        
        // Hide the modal
        modal.classList.add('hidden');
        console.debug(`Modal hidden: ${modalId || 'unknown'}`);
        return true;
    } catch (error) {
        console.error('Error hiding modal:', error);
        return false;
    }
}

/**
 * Safe modal showing function
 * @param {string} modalId - ID of modal to show
 * @returns {boolean} - Success status
 */
function showModal(modalId) {
    try {
        const modal = document.getElementById(modalId);
        
        if (!modal) {
            console.warn(`Modal with ID '${modalId}' not found`);
            return false;
        }
        
        if (!modal.classList) {
            console.warn('Modal element does not have classList');
            return false;
        }
        
        modal.classList.remove('hidden');
        console.debug(`Modal shown: ${modalId}`);
        return true;
    } catch (error) {
        console.error('Error showing modal:', error);
        return false;
    }
}

/**
 * Close all HTML modals (not app-modal class)
 */
function closeAllModals() {
    try {
        const modals = document.querySelectorAll('.modal:not(.app-modal)');
        modals.forEach(modal => {
            if (modal.id) {
                hideModal(modal.id);
            }
        });
        console.debug('All HTML modals closed');
    } catch (error) {
        console.error('Error closing all modals:', error);
    }
}

// ============================================================================
// EVENT HANDLERS - Global modal control
// ============================================================================

/**
 * Handle clicks outside modal content
 * Only closes HTML modals, not app-modals
 */
document.addEventListener('click', (e) => {
    try {
        // Skip if no target
        if (!e.target || !e.target.classList) {
            return;
        }
        
        // CRITICAL: Skip app-modal class (app.js dynamic modals)
        if (e.target.classList.contains('app-modal')) {
            return;
        }
        
        // Only process HTML modals
        if (e.target.classList.contains('modal') && !e.target.classList.contains('app-modal')) {
            const modalContent = e.target.querySelector('.modal-content');
            
            if (modalContent) {
                // Check if click was outside content
                if (!modalContent.contains(e.target)) {
                    // Clicked on background, close it
                    hideModal(e.target.id);
                }
            }
        }
    } catch (error) {
        console.error('Error in backdrop click handler:', error);
    }
}, false);

/**
 * Stop propagation for app-modal content clicks ONLY
 * Prevents clicks inside app-modal from closing it
 * Does NOT interfere with HTML modals
 */
document.addEventListener('click', (e) => {
    try {
        const appModal = e.target.closest('.modal.app-modal');
        if (appModal) {
            const modalContent = e.target.closest('.modal-content');
            if (modalContent) {
                // Only stop propagation for app-modal content
                e.stopPropagation();
            }
        }
    } catch (error) {
        console.error('Error in content click handler:', error);
    }
}, true); // Capture phase to intercept early

/**
 * Handle Escape key - closes HTML modals only
 */
document.addEventListener('keydown', (e) => {
    try {
        if (e.key === 'Escape' || e.key === 'Esc') {
            // Only close HTML modals, not app-modals
            const openModals = document.querySelectorAll('.modal:not(.app-modal):not(.hidden)');
            
            if (openModals.length > 0) {
                // Close the last (top) modal
                const topModal = openModals[openModals.length - 1];
                if (topModal.id) {
                    hideModal(topModal.id);
                }
            }
        }
    } catch (error) {
        console.error('Error in Escape key handler:', error);
    }
});

// ============================================================================
// HELPER FUNCTION - For app.js to use
// ============================================================================

/**
 * Setup button groups for app.js modals
 * Handles click events with proper event propagation
 * 
 * Usage:
 * setupButtonGroup(container, dataType, onSelect);
 * 
 * Example:
 * setupButtonGroup(
 *     document.querySelector('#quick-expense-mode-buttons'),
 *     'expense-mode',
 *     (value) => { document.getElementById('selected-expense-mode').value = value; }
 * );
 */
function setupButtonGroup(container, dataType, onSelect) {
    if (!container) {
        console.warn('Container not found for button group');
        return;
    }
    
    const buttons = container.querySelectorAll(`[data-type="${dataType}"], [data-value]`);
    
    if (buttons.length === 0) {
        console.warn(`No buttons found for dataType: ${dataType}`);
        return;
    }
    
    buttons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            // CRITICAL: Prevent event from bubbling
            e.stopPropagation();
            e.preventDefault();
            
            // Remove active state from all buttons
            buttons.forEach(b => {
                b.style.background = 'var(--bg-light)';
                b.style.borderColor = 'var(--border-color)';
                b.style.color = 'var(--text-dark)';
                b.classList.remove('active');
            });
            
            // Add active state to clicked button
            btn.style.background = 'var(--primary-color)';
            btn.style.borderColor = 'var(--primary-color)';
            btn.style.color = 'white';
            btn.classList.add('active');
            
            // Call the callback with value
            const value = btn.dataset.value;
            if (onSelect && typeof onSelect === 'function') {
                onSelect(value);
            }
            
            console.debug(`Button selected: ${dataType} = ${value}`);
        }, false);
    });
}

/**
 * Setup rating buttons for app.js modals
 * 
 * Usage:
 * setupRatingButtons(container, onRate);
 * 
 * Example:
 * setupRatingButtons(
 *     document.querySelector('.rating-buttons'),
 *     (rating) => { document.getElementById('activity-rating').value = rating; }
 * );
 */
function setupRatingButtons(container, onRate) {
    if (!container) {
        console.warn('Container not found for rating buttons');
        return;
    }
    
    const buttons = container.querySelectorAll('.rating-btn, button[data-rating]');
    
    if (buttons.length === 0) {
        console.warn('No rating buttons found');
        return;
    }
    
    buttons.forEach((btn, idx) => {
        btn.addEventListener('click', (e) => {
            // CRITICAL: Prevent event from bubbling
            e.stopPropagation();
            e.preventDefault();
            
            // Update visual state for all buttons
            buttons.forEach((b, i) => {
                b.style.opacity = i <= idx ? '1' : '0.3';
            });
            
            // Call callback with rating
            const rating = idx + 1;
            if (onRate && typeof onRate === 'function') {
                onRate(rating);
            }
            
            console.debug(`Rating selected: ${rating} stars`);
        }, false);
    });
}

// ============================================================================
// EXPOSE FUNCTIONS TO WINDOW
// ============================================================================

window.hideModal = hideModal;
window.showModal = showModal;
window.closeAllModals = closeAllModals;
window.setupButtonGroup = setupButtonGroup;
window.setupRatingButtons = setupRatingButtons;

console.log('Modal management system initialized');

</script>

<!-- ============================================================================
     CSS FOR MODALS - Add this to your stylesheet if not already present
     ============================================================================ -->

<style>
/* Modal container */
.modal {
    display: flex;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    align-items: center;
    justify-content: center;
    pointer-events: auto;
}

.modal.hidden {
    display: none;
    pointer-events: none;
}

.modal-content {
    background-color: #fefefe;
    padding: 20px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    pointer-events: auto;
    z-index: 1001;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.modal-content * {
    pointer-events: auto;
}

/* Close button */
.close-button {
    cursor: pointer;
    font-size: 1.5rem;
    font-weight: bold;
    line-height: 1;
    transition: color 0.2s;
}

.close-button:hover {
    color: red;
}

/* Form actions */
.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    justify-content: flex-end;
    flex-wrap: wrap;
}

.form-actions .btn {
    min-width: 100px;
}

/* App modals - same styling */
.modal.app-modal {
    display: flex;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    align-items: center;
    justify-content: center;
    pointer-events: auto;
}

.modal.app-modal.hidden {
    display: none;
    pointer-events: none;
}
</style>

<!-- ============================================================================
     NOTES FOR app.js IMPLEMENTATION
     ============================================================================

When creating modals in app.js, do the following:

1. Add app-modal class:
   modal.className = 'modal app-modal';

2. For button groups, after creating modal:
   setupButtonGroup(
       modal.querySelector('#quick-expense-mode-buttons'),
       'expense-mode',
       (value) => {
           document.getElementById('selected-expense-mode').value = value;
       }
   );

3. For rating buttons, after creating modal:
   setupRatingButtons(
       modal.querySelector('.rating-buttons'),
       (rating) => {
           document.getElementById('activity-rating').value = rating;
       }
   );

4. For showMessage modal, add app-modal class to the modal element

This ensures:
✅ Close buttons work
✅ Cancel buttons work
✅ X buttons work
✅ Rating selection works
✅ Payment mode selection works
✅ Global hideModal() doesn't interfere
✅ Escape key closes only HTML modals
✅ Click outside only closes HTML modals

============================================================================ -->


</body>
</html>